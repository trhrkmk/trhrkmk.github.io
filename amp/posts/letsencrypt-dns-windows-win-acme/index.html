<!DOCTYPE html>
<html ⚡>
  <head>
    <meta charset="utf-8">
<meta name="pinterest" content="nopin">
<meta name="viewport" content="width=device-width,minimum-scale=1,initial-scale=1">
<meta name="theme-color" content="#263238">

<meta name="generator" content="Hugo 0.55.6" />

<link rel="apple-touch-icon" href="https://www.trhrkmk.com/images/logo.png">


<link rel="canonical" href="https://www.trhrkmk.com/amp/posts/letsencrypt-dns-windows-win-acme/">



    <style amp-boilerplate>body{-webkit-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-moz-animation:-amp-start 8s steps(1,end) 0s 1 normal both;-ms-animation:-amp-start 8s steps(1,end) 0s 1 normal both;animation:-amp-start 8s steps(1,end) 0s 1 normal both}@-webkit-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-moz-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-ms-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@-o-keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}@keyframes -amp-start{from{visibility:hidden}to{visibility:visible}}</style><noscript><style amp-boilerplate>body{-webkit-animation:none;-moz-animation:none;-ms-animation:none;animation:none}</style></noscript>
    <script async src="https://cdn.ampproject.org/v0.js"></script>
    <script async custom-element="amp-analytics" src="https://cdn.ampproject.org/v0/amp-analytics-0.1.js"></script>
    <script async custom-element="amp-twitter" src="https://cdn.ampproject.org/v0/amp-twitter-0.1.js"></script>

    
    <link href="https://fonts.googleapis.com/css?family=Lobster%7cLato:400,700" rel="stylesheet">
    
    <link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.5.0/css/font-awesome.min.css" rel="stylesheet">
    <title>Windows ServerでLet&#39;s EncryptのDNS認証を試みて失敗した話 - HHKBは体の一部</title>
    
<meta name="description" content="&lt;p&gt;以前、&lt;a href=&#34;https://www.trhrkmk.com/amp/posts/filemaker-server-ssl-letsencrypt-windows-server/&#34; target=&#34;_blank&#34;&gt;FileMaker ServerにLet&amp;rsquo;s EncryptのSSL証明書を設定する&lt;/a&gt;というブログを書きました。&lt;/p&gt;&lt;p&gt;ブログを書いている時は、&lt;strong&gt;HTTPでの認証が一般的だろう&lt;/strong&gt;程度でやっていました。&lt;/p&gt;&lt;p&gt;しかし、もっと簡単にできるはずだ！と思いググってみた。&lt;/p&gt;">

<meta property="og:title" content="Windows ServerでLet&#39;s EncryptのDNS認証を試みて失敗した話 - HHKBは体の一部">
<meta property="og:type" content="article">
<meta property="og:url" content="https://www.trhrkmk.com/amp/posts/letsencrypt-dns-windows-win-acme/">
<meta property="og:image" content="https://www.trhrkmk.com/images/letsencrypt-dns-windows-win-acme/letsencrypt-dns-windows-win-acme-1.png">
<meta property="og:site_name" content="HHKBは体の一部">
<meta property="og:description" content="&lt;p&gt;以前、&lt;a href=&#34;https://www.trhrkmk.com/amp/posts/filemaker-server-ssl-letsencrypt-windows-server/&#34; target=&#34;_blank&#34;&gt;FileMaker ServerにLet&amp;rsquo;s EncryptのSSL証明書を設定する&lt;/a&gt;というブログを書きました。&lt;/p&gt;&lt;p&gt;ブログを書いている時は、&lt;strong&gt;HTTPでの認証が一般的だろう&lt;/strong&gt;程度でやっていました。&lt;/p&gt;&lt;p&gt;しかし、もっと簡単にできるはずだ！と思いググってみた。&lt;/p&gt;">
<meta property="og:locale" content="ja_JP">

<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:site" content="HHKBは体の一部">
<meta name="twitter:url" content="https://www.trhrkmk.com/amp/posts/letsencrypt-dns-windows-win-acme/">
<meta name="twitter:title" content="Windows ServerでLet&#39;s EncryptのDNS認証を試みて失敗した話 - HHKBは体の一部">
<meta name="twitter:description" content="&lt;p&gt;以前、&lt;a href=&#34;https://www.trhrkmk.com/amp/posts/filemaker-server-ssl-letsencrypt-windows-server/&#34; target=&#34;_blank&#34;&gt;FileMaker ServerにLet&amp;rsquo;s EncryptのSSL証明書を設定する&lt;/a&gt;というブログを書きました。&lt;/p&gt;&lt;p&gt;ブログを書いている時は、&lt;strong&gt;HTTPでの認証が一般的だろう&lt;/strong&gt;程度でやっていました。&lt;/p&gt;&lt;p&gt;しかし、もっと簡単にできるはずだ！と思いググってみた。&lt;/p&gt;">
<meta name="twitter:image" content="https://www.trhrkmk.com/images/letsencrypt-dns-windows-win-acme/letsencrypt-dns-windows-win-acme-1.png">


<script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "NewsArticle",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id":"https:\/\/www.trhrkmk.com\/"
    },
    "headline": "Windows ServerでLet\x27s EncryptのDNS認証を試みて失敗した話 - HHKBは体の一部",
    "image": {
      "@type": "ImageObject",
      "url": "https:\/\/www.trhrkmk.com\/images\/letsencrypt-dns-windows-win-acme\/letsencrypt-dns-windows-win-acme-1.png",
      "height": 800,
      "width": 800
    },
    "datePublished": "2018-09-22T10:08:11JST",
    "dateModified": "2019-02-02T10:08:11JST",
    "author": {
      "@type": "Person",
      "name": "HHKBは体の一部"
    },
    "publisher": {
      "@type": "Organization",
      "name": "HHKBは体の一部",
      "logo": {
        "@type": "ImageObject",
        "url": "https:\/\/www.trhrkmk.com\/images/logo.png",
        "width": 600,
        "height": 60
      }
    },
    "description": "\x3cp\x3e以前、\x3ca href=\x22https:\/\/www.trhrkmk.com\/amp\/posts\/filemaker-server-ssl-letsencrypt-windows-server\/\x22 target=\x22_blank\x22\x3eFileMaker ServerにLet\x26rsquo;s EncryptのSSL証明書を設定する\x3c\/a\x3eというブログを書きました。\x3c\/p\x3e\n\n\x3cp\x3eブログを書いている時は、\x3cstrong\x3eHTTPでの認証が一般的だろう\x3c\/strong\x3e程度でやっていました。\x3c\/p\x3e\n\n\x3cp\x3eしかし、もっと簡単にできるはずだ！と思いググってみた。\x3c\/p\x3e"
  }
</script>


    <style amp-custom>
      html { font-size: 18px; background-color: rgba(236,239,241,.5);}@media (max-width: 768px) { html { font-size: 15px; }}body { color: #333; font-family: 'Roboto Slab','ヒラギノ角ゴ Pro W3','Hiragino Kaku Gothic Pro',メイリオ,Meiryo,sans-serif; font-feature-settings : "palt"; font-size: inherit; line-height: 1rem; margin: 0; padding: 0;}h1, h2, h3, h4, h5 ,h6 { font-size: 1rem; font-weight: 700; line-height: 1rem; margin: 0;}hr { border: 0; border-top: 1px dashed #cfd8dc; margin: 1rem 0;}p { margin: 0; line-height: 1rem;}a { color: #2196f3; text-decoration: none; transition-duration: .3s;}ul, ol { margin: 0; padding: 0;}table { border-collapse: collapse;}th, td { font-size: .8rem; padding: .5rem;}tr { border-bottom: 1px dashed #ddd;}/* Layouts */main,aside { display: block;}main { padding: 1rem 0 3rem 0; }aside.h { padding: 3rem 0; }main.f,aside.f { background-color: #333; border-top: 2px dashed #fff; border-bottom: 2px dashed #fff;}.l-container { position: relative; max-width: 68rem; margin: 0 auto; padding: 0 1rem;}.l-container.thin { max-width: 44rem;}.l-header { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); padding: 1rem 0; text-align: center;}.l-header .description { margin-top: .5rem; font-size: .8rem;}.l-footer { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); font-size: .6rem; font-weight: 700; padding: 1rem 0;}@media (max-width: 768px) { .l-sidebar { margin-top: 4rem; }}.mrow { margin: 0 -1rem; overflow: hidden;}.mcol { box-sizing: border-box; float: left; padding: 0 1rem;}.c6 { width: 50%; }.c4 { width: 33.26323833%; }.c8 { width: 66.66666%; }@media (max-width: 768px) { .mcol { width: 100%; float: none; }}.logo a { font-size: 1.4rem; line-height: 1.5rem; font-weight: 700; color: #333;}.articles { margin: -1rem 0; margin-bottom: 1rem;}.articles.sm { margin: -.5rem 0; margin-bottom: 0;}article { border-radius: 4px; overflow: hidden;}article.li { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); height: 20rem; overflow: hidden; margin: 1rem 0;}article.li > a { display: block; color: #333;}article.li .inner { padding: 1rem;}article.li .thumb { height: 8rem;}article.li .title { color: #333; font-size: 1.2rem; line-height: 1.5rem; margin-bottom: .5rem;}article.li .summary { font-size: .8rem; height: 6rem; overflow: hidden; margin-top: 1rem;}article.li .summary::after { content: '...';}article.lism { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); margin: .5rem 0;}article.lism::after { content: ''; display: block; clear: both;}article.lism > a { display: block; color: #333;}article.lism .inner { display: table-cell; vertical-align: middle; height: 5rem; padding: 0 .75rem;}article.lism .thumb { width: 5rem; height: 5rem; float: left;}article.lism .title { font-weight: 700; font-size: .8rem; margin-bottom: .25rem;}article.sn { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); margin-bottom: 1rem;}article.sn .thumb { height: 20rem;}@media (max-width: 768px) { article.sn .thumb { height: 10rem; }}article.sn > .article-header,article.sn > .article-body,article.sn .article-footer { padding: 2rem;}article.sn > .article-body { padding: 0 2rem;}@media (max-width: 768px) { article.sn > .article-header, article.sn > .article-body, article.sn .article-footer { padding: 1rem; } article.sn > .article-body { padding: 0 1rem; }}article.sn > .article-header .title { font-size: 1.8rem; line-height: 2rem; margin-bottom: .5rem;}@media (max-width: 768px) { article.sn > .article-header .title { font-size: 1.4rem; line-height: 1.5rem; }}article.sn > .article-header .facts { margin-bottom: 1rem;}article.sn > .article-body { margin-bottom: 1.5rem;}article.sn > .article-body h2 { border-bottom: .25rem solid #333; font-size: 1.2rem; line-height: 1.5rem; margin: 1.5rem 0; padding: .5rem 0;}article.sn > .article-body h3 { border-left: .5rem solid #333; line-height: 1.5rem; margin: 1.5rem 0; padding: .125rem .5rem;}article.sn > .article-body ul,article.sn > .article-body ol { margin: 1.5rem 0; padding-left: 1.5rem;}article.sn > .article-body li { padding-bottom: .5rem; line-height: 1.5rem;}article.sn > .article-body li:last-child { padding-bottom: 0;}article.sn > .article-body p { margin: 1rem 0; line-height: 1.5rem;}article.sn > .article-body strong,article.sn > .article-body em { font-style: normal; font-weight: 700;}article.sn > .article-body strong { box-shadow: 0 -.5rem 0 0 #ffc107 inset;}article.sn > .article-body em { color: #8bc34a;}article.sn > .article-body code,article.sn > .article-body pre { font-family: Menlo, Consolas, monospace; font-size: .7rem;}article.sn > .article-body pre { background-color: #333; color: #fff; line-height: 1rem; margin: 1.5rem -2rem; overflow: auto;}@media (max-width: 768px) { article.sn > .article-body pre { margin: 1.5rem -1rem; }}article.sn > .article-body pre > code { display: block; padding: 1rem 2rem;}@media (max-width: 768px) { article.sn > .article-body pre > code { padding: 1rem; }}article.sn > .article-body p code { background-color: #eceff1; color: #333; border-radius: 4px; margin: 0 .25rem; padding: .375rem; white-space: nowrap;}article.sn > .article-body blockquote { position: relative; border-left: .25rem solid #333; font-size: .8rem; padding: .125rem 1rem; margin: 1.5rem 0;}@media (max-width: 768px) { article.sn > .article-body blockquote { font-size: 1rem; }}article.sn > .article-body blockquote p { margin: .5rem 0; line-height: 1rem;}article.sn > .article-body figure { margin: 1.5rem 0;}article.sn > .article-body img,article.sn > .article-body figure img,article.sn > .article-body figure amp-img { box-shadow: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24); max-width: 100%;}article.sn > .article-body figcaption { color: #cfd8dc; font-size: .8rem; font-weight: 700; margin-top: .5rem;}.facts li { display: inline; font-size: .8rem; margin-right: 1rem;}.facts i { color: #cfd8dc; margin-right: .5em;}.facts.sm li { font-size: .7rem;}.sections.sidebar { margin: -1rem 0;}.sections.footer { margin: -1rem 0;}section.sidebar { margin: 2rem 0;}section.sidebar > header { font-size: .8rem; font-weight: 700; letter-spacing: 4px; text-align: center; margin: 1.5rem 0;}section.footer { margin: 1rem 0;}section.footer > header { font-size: .8rem; margin: .5rem 0;}section.footer > header::before { content: "- ";}section.footer > header a { font-weight: 700; color: #333; text-decoration: underline;}.terms { margin: -.25rem;}.terms li { display: inline-block;}.terms a { display: block; float: left; background-color: #333; border-radius: 4px; color: #fff; font-size: .7rem; margin: .25rem; padding: 0 .75rem; line-height: 1.75rem;}.paging { text-align: center; padding: 1rem 0;}.paging a { display: inline-block; background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); border-radius: 4px; color: #333; padding: 0 1rem; line-height: 3rem;}.page-title { text-align: center; margin: 1rem 0;}.page-title::after { content: ''; display: block; border-bottom: .25rem solid #333; width: 3rem; margin: 1.5rem auto;}.page-title > .title { font-size: 1.2rem; line-height: 1.5rem;}/* Parts:breadcrumb */.crumb ol { text-overflow: ellipsis; color: #cfd8dc; white-space: nowrap; overflow: hidden;}.crumb li { display: inline; font-size: .8rem;}.crumb li::after { content: '›'; margin: 0 .25rem 0 .5rem;}.crumb li:last-child::after { content: '';}.crumb a { color: #cfd8dc;}.crumb i { margin-right: .5em;}.share { padding: 0;}.share a { display: inline-block; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); min-width: 1rem; height: 2rem; border-radius: 4px; color: #333; font-size: .8rem; font-weight: 700; line-height: 2rem; text-align: center; padding: 0 .5rem;}.adj article.lism { margin-bottom: 1rem;}.adj header { font-weight: 700; font-size: .8rem;}.toc { padding: 0 2rem;}@media (max-width: 768px) { .toc { padding: 0 1rem; }}.toc { margin: 1rem 0;}.toc nav>ul { background-color: #eceff1; border-radius: 4px; display: inline-block; font-size: .8rem; padding: .5rem 1rem; word-break: break-all; list-style: none;}.toc ul { padding: 0;}.toc ul ul { padding-left: 1rem;}.toc ul ul ul { padding-left: 1rem;}.toc li { color: #90a4ae;}.toc ul ul>li { font-weight: 700; margin: .5rem 0; list-style-type: decimal;}.toc ul ul ul>li { list-style-type: disc; font-weight: 500;}.author { background-color: #fff; box-shadow: 0 0 0 1px rgba(63,63,68,.05), 0 1px 3px rgba(63,63,68,.1), 0 1px 2px rgba(0,0,0,.05); padding: 1rem; border-radius: 4px; text-align: center;}.author .author-thumb { margin: 0 auto 1rem; width: 6rem; height: 6rem; border-radius: 50%; background-color: #eceff1; background-size: cover; background-position: center;}.author .author-name { margin-bottom: .5rem; font-weight: 700;}.author .author-facts { margin-bottom: 1rem;}.author .author-facts li { display: inline;}.author .author-facts li a { display: inline-block; background-color: #eceff1; width: 1.75rem; height: 1.75rem; line-height: 1.75rem; text-align: center; color: #333; font-size: .8rem; border-radius: 2px;}.author .author-facts li a:hover { color: #fff; background-color: #333;}.author .author-description { text-align: left; font-size: .8rem;}.author .author-description p { margin: .5rem 0;}.thumb { background-image: url(https://www.trhrkmk.com/images/thumbnail/default.jpg); background-size: cover; background-position: center;}.thumb-fcd977ec5688a734568a65ab59deefb9 { background-image: url(https://www.trhrkmk.com/images/bought-keyboard-vortex-core/bought-keyboard-vortex-core-1.jpg);}.thumb-5554f06349ec1f71fbc2681fd503bb7e { background-image: url(https://www.trhrkmk.com/images/thinkpad-bluetooth-keyboard-keytop-orderd/laptopkey-1.jpg);}.thumb-14b351dcf29db29c5660e7817413a30c { background-image: url(https://www.trhrkmk.com/images/hugo/hugo.png);}.thumb-c65a27d390a620d7bd687fb6b44b12ea { background-image: url(https://www.trhrkmk.com/images/bash/bash.png);}.thumb-58dbb4801ad94f74f38ede0f10878041 { background-image: url(https://www.trhrkmk.com/images/bash/bash.png);}.thumb-4266cb1ef76ee983573bb68f0370b4b0 { background-image: url(https://www.trhrkmk.com/images/vim/vim.png);}.thumb-01fb886ffdfe3ab96998d8430fd86869 { background-image: url(https://www.trhrkmk.com/images/purchased-thinkpad-t480s/thinkpad-t480s.png);}.thumb-4c6e3fb64644d2b1c3c5b8b2ef7806d8 { background-image: url(https://www.trhrkmk.com/images/bash/bash.png);}.thumb-8d1547d1de5ed1de49cd04c7fcb13e97 { background-image: url(https://www.trhrkmk.com/images/bash/bash.png);}.thumb-d15fa695c6416a710e0b16ac0945e5e8 { background-image: url(https://www.trhrkmk.com/images/fzf-command-line-productivity-tools/fzf-command-line-tools-7.png);}.thumb-ab9d8d7db485dd06772fef054384b0ee { background-image: url(https://www.trhrkmk.com/images/bash/bash.png);}.thumb-48829181f822197d67aae0bd2e10a89d { background-image: url(https://www.trhrkmk.com/images/lightsail-bitnami-redmine-letsencrypt/lightsail-bitnami-redmine-letsencrypt-1.png);}.thumb-f5e515ece7bcac5194b3ee1f86417cc8 { background-image: url(https://www.trhrkmk.com/images/letsencrypt-dns-windows-win-acme/letsencrypt-dns-windows-win-acme-1.png);}.thumb-211a68066326af57662195e4fd3c867c { background-image: url(https://www.trhrkmk.com/images/hugo/hugo.png);}.thumb-48d142721a390e870478036f7904163c { background-image: url(https://www.trhrkmk.com/images/filemaker-server-ssl-letsencrypt-windows-server/filemaker-server-ssl-letsencrypt-windows-server-7.png);}.thumb-b92f7b8ee6916c4e6c4b0a6542324cb5 { background-image: url(https://www.trhrkmk.com/images/filemaker-text-label-get-function/filemaker-text-label-get-function-1.png);}.thumb-37addc00d0b9c90d85e5bcc3c96e5641 { background-image: url(https://www.trhrkmk.com/images/hugo-share-button-addthis/hugo-share-button-addthis-1.png);}.thumb-b40d8f5050184fb578c9e2a9d48b0729 { background-image: url(https://www.trhrkmk.com/images/linux-textexpander-typinator-similar-app-introduction/texpander-1.png);}.thumb-b83507c5dabe1c8dc80f6d0e5d00803d { background-image: url(https://www.trhrkmk.com/images/filemaker-fmperception-check-unreferenced/fmperception-unreferenced-1.png);}.thumb-609fe292361a3aa310e4908207f2c905 { background-image: url(https://www.trhrkmk.com/images/debian-stretch-install-firefox-latest/firefox-latest-1.png);}.thumb-595902e3f91a7903b2e09e54e9d6166a { background-image: url(https://www.trhrkmk.com/images/blog-hugo-start/hugo-1.png);}
      
       body { font-family: Lato,YuGothic,'Hiragino Kaku Gothic Pro',Meiryo,sans-serif; } 
       .h-logo { font-family: Lobster, cursive; } 
      .l-container { max-width: 40rem; margin: 0 auto; }
    </style>
    <script async custom-element="amp-auto-ads"
        src="https://cdn.ampproject.org/v0/amp-auto-ads-0.1.js">
</script>
  </head>

  <body>
    
    <amp-analytics type="googleanalytics" id="analytics1">
      <script type="application/json"> { "vars": { "account": "UA-90586336-1"}, "triggers": { "trackPageview": { "on": "visible", "request": "pageview" } } }
      </script>
    </amp-analytics>
    

    <header class="l-header">
      <div class="l-container">
        <div class="logo">
          <a href="https://www.trhrkmk.com/">HHKBは体の一部</a>
        </div>
      </div>
    </header>

    <main>
      <div class="l-container">
        
<article class="sn">

  <div class="thumb thumb-f5e515ece7bcac5194b3ee1f86417cc8"></div>

  <header class="article-header">
    <h1 class="title">Windows ServerでLet&#39;s EncryptのDNS認証を試みて失敗した話</h1>

    <ul class="facts">
      <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2018-09-22T10:08:11JST">2018-09-22</time></li>
      <li><i class="fa fa-refresh" aria-hidden="true"></i><time datetime="2019-02-02T10:08:11JST">2019-02-02</time></li>
      <li><i class="fa fa-bookmark" aria-hidden="true"></i><a href="https://www.trhrkmk.com/posts/">POSTS</a></li>
      
    </ul>

  </header>

  
  <div class="toc">
    <nav id="TableOfContents">
<ul>
<li>
<ul>
<li><a href="#更新">更新</a>
<ul>
<li><a href="#2019-02-02">2019-02-02</a></li>
</ul></li>
<li><a href="#win-acmeでdns認証を試みる">win-acmeでDNS認証を試みる</a>
<ul>
<li><a href="#githubのwikiを確認する">GitHubのWikiを確認する</a></li>
<li><a href="#dns認証時に利用するスクリプト">DNS認証時に利用するスクリプト</a></li>
<li><a href="#dnsサーバーを追加">DNSサーバーを追加</a></li>
<li><a href="#実行してみた時のログ">実行してみた時のログ</a></li>
<li><a href="#そもそも">そもそも</a></li>
</ul></li>
<li><a href="#go製のacmeクライアントを使えば良いのではないか">Go製のACMEクライアントを使えば良いのではないか？</a></li>
<li><a href="#そもそもwindowsじゃなくて良いのではないか">そもそもWindowsじゃなくて良いのではないか？</a></li>
<li><a href="#あとがき">あとがき</a></li>
</ul></li>
</ul>
</nav>
  </div>
  

  <div class="article-body"><p>以前、<a href="https://www.trhrkmk.com/amp/posts/filemaker-server-ssl-letsencrypt-windows-server/" target="_blank">FileMaker ServerにLet&rsquo;s EncryptのSSL証明書を設定する</a>というブログを書きました。</p>

<p>ブログを書いている時は、<strong>HTTPでの認証が一般的だろう</strong>程度でやっていました。</p>

<p>しかし、もっと簡単にできるはずだ！と思いググってみた。</p>

<h2 id="更新">更新</h2>

<h3 id="2019-02-02">2019-02-02</h3>

<p>以下の記事を書きましたので、よろしければご覧ください。</p>

<p><a href="https://frudens.jp/lego-filemaker-server-windows-server-2016-ssl-letsencrypt-dns/" target="_blank">legoを使ってLet’s EncryptのSSL証明書をDNS認証で発行しFileMaker Serverに設定する方法</a></p>

<hr />

<p>DNSのTXTレコードを設定すれば、DNS認証ができると分かったので、せっかくなのでチャレンジしてみた。</p>

<p>結果的には途中で諦めて、DebianでDNS認証をしちゃいましたが、Windows環境で色々と模索したので、メモを残しておきます。</p>

<h2 id="win-acmeでdns認証を試みる">win-acmeでDNS認証を試みる</h2>

<h3 id="githubのwikiを確認する">GitHubのWikiを確認する</h3>

<p>こういうときは、<a href="https://github.com/PKISharp/win-acme/wiki" target="_blank">Wiki Home</a>を見ましょう。</p>

<p>win-acmeは、DNS認証は対応しているとのこと。</p>

<p>CLIツールレベルで対応しているのは、<a href="https://github.com/PKISharp/win-acme/wiki/Azure-DNS-validation" target="_blank">Azure DNS validation</a>だけのようです。</p>

<p>その他のDNSを使っている場合は、<strong>自分でスクリプトを書いて指定してね。</strong>ということみたい。</p>

<h3 id="dns認証時に利用するスクリプト">DNS認証時に利用するスクリプト</h3>

<p>スクリプトについて、具体的にどのように記述して指定するのかをググってみた。</p>

<ul>
<li><a href="https://github.com/PKISharp/win-acme/wiki/Example-Scripts" target="_blank">Example Scripts</a></li>
<li><a href="https://github.com/PKISharp/win-acme/wiki/Validation-plugins#dns-01-validation" target="_blank">Validation plugins</a></li>
<li><a href="https://github.com/PKISharp/win-acme/issues/817" target="_blank">How to &ldquo;Run external program/script to create and update records&rdquo; #817</a></li>
<li><a href="https://github.com/PKISharp/win-acme/issues/841" target="_blank">Can I use Win-ACME (v1.9.10.1) to validate using &ldquo;dns-01&rdquo;? #841</a></li>
</ul>

<p>このリンクの方が、具体的なコードを書いてくれていました。</p>

<p><a href="https://github.com/PKISharp/win-acme/issues/817#issuecomment-381164264" target="_blank">https://github.com/PKISharp/win-acme/issues/817#issuecomment-381164264</a></p>

<pre><code class="language-cli">I created scripts to do this that work on server 2012.
As my server is behind a firewall this turned out to be the wrong method to use, but you may find them useful.
Replace DNSServer with the name of your DNSserver and repeat that line if you have more than one server.
Replace YourZoneName with your domain name.

create-dns.bat:
powershell -file ./create-dns.ps1 %1 %2 %3

create-dns.ps1:
Import-module dnsserver
Add-DnsServerResourceRecord -Name $args[1] -Computername DNSServer-TXT -ZoneName &quot;YourZoneName&quot; -DescriptiveText $args[2]

delete-dns.bat:
powershell -file ./delete-dns.ps1 %1 %2

delete-dns.ps1:
Import-module dnsserver
Remove-DnsServerResourceRecord -Force -Computername DNSServer-ZoneName &quot;YourZoneName&quot; -RRType &quot;Txt&quot; -Name $args[1]
</code></pre>

<h3 id="dnsサーバーを追加">DNSサーバーを追加</h3>

<p>Windows ServerにDNSサーバーを追加しました。</p>

<h3 id="実行してみた時のログ">実行してみた時のログ</h3>

<pre><code class="language-cli"> [INFO] A Simple ACME Client for Windows (WACS)
 [INFO] Software version 1911.2.6726.40690 (RELEASE)
 [INFO] IIS version 10.0
 [INFO] ACME server https://acme-v01.api.letsencrypt.org/
 [INFO] Please report issues at https://github.com/PKISharp/win-acme

 N: Create new certificate
 M: Create new certificate with advanced options
 L: List scheduled renewals
 R: Renew scheduled
 S: Renew specific
 A: Renew *all*
 V: Revoke certificate
 C: Cancel scheduled renewal
 X: Cancel *all* scheduled renewals
 Q: Quit

 Please choose from the menu: m

 [INFO] Running in Advanced mode

 1: Single binding of an IIS site
 2: SAN certificate for all bindings of an IIS site
 3: SAN certificate for all bindings of multiple IIS sites
 4: Manually input host names
 C: Cancel

 Which kind of certificate would you like to create?: 4

 Enter comma-separated list of host names, starting with the primary one: hoge2.frudens.app

 [INFO] Plugin Manual generated target [Manual] [1 binding - hoge2.frudens.app]

 1: [dns-01] Azure DNS
 2: [dns-01] Run external program/script to create and update records
 3: [http-01] Save file on local (network) path
 4: [http-01] Self-host verification files (recommended)
 5: [http-01] Upload verification file to FTP(S) server
 6: [http-01] Upload verification file to WebDav path
 C: Cancel

 How would you like to validate this certificate?: 2

 Path to script that creates DNS records. Parameters passed are the hostname, record name and token: scripts\create-dns.bat

 Path to script that deletes DNS records. Parameters passed are the hostname and record name: scripts\delete-dns.bat

 1: Create or update ftps bindings in IIS
 2: Create or update https bindings in IIS
 3: Do not run any installation steps
 4: Run a custom script
 C: Cancel

 Which installer should run for the certificate?: 3

 [INFO] Authorize identifier: hoge2.frudens.app
 [INFO] Authorizing hoge2.frudens.app using dns-01 validation (DnsScript)
 [INFO] Script scripts\create-dns.bat starting with parameters hoge2.frudens.app _acme-challenge.hoge2.frudens.app hw6PTBqElAV9MUhPjNVavDu948jnQ1PGLDeilb6kVnU [INFO]
C:\Users\teruhirokomaki\Desktop\win-acme.v1.9.11.2&gt;powershell.exe -ExecutionPolicy RemoteSigned -File .\scripts\create-dns.ps1 hoge2.frudens.app _acme-challenge.hoge2.frudens.app hw6PTBqElAV9MUhPjNVavDu948jnQ1PGLDeilb6kVnU

 [WARN] Script execution timed out after 5 minutes, will keep running in the background
 [INFO] Answer should now be available at _acme-challenge.hoge2.frudens.app
 [INFO] Script scripts\delete-dns.bat starting with parameters hoge2.frudens.app _acme-challenge.hoge2.frudens.app
 [EROR] Script error: Remove-DnsServerResourceRecord : Failed to get the zone information for hoge2.frudens.app on server DNSServer-ZoneName.
 [EROR] Script error: At C:\Users\teruhirokomaki\Desktop\win-acme.v1.9.11.2\scripts\delete-dns.ps1:2 char:1
 [EROR] Script error: + Remove-DnsServerResourceRecord -Force -Computername DNSServer-ZoneNam ...
 [EROR] Script error: + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
 [EROR] Script error:     + CategoryInfo          : NotSpecified: (_acme-challenge.hoge2.frudens.app:root/Microsoft/...rResourceRecord) [Rem
 [EROR] Script error:    ove-DnsServerResourceRecord], CimException
 [EROR] Script error:     + FullyQualifiedErrorId : WIN32 1722,Remove-DnsServerResourceRecord
 [INFO]
C:\Users\teruhirokomaki\Desktop\win-acme.v1.9.11.2&gt;powershell.exe -ExecutionPolicy RemoteSigned -File .\scripts\delete-dns.ps1 hoge2.frudens.app _acme-challenge.hoge2.frudens.app
Error: Remove-DnsServerResourceRecord : Failed to get the zone information for hoge2.frudens.app on server DNSServer-ZoneName.
Error: At C:\Users\teruhirokomaki\Desktop\win-acme.v1.9.11.2\scripts\delete-dns.ps1:2 char:1
Error: + Remove-DnsServerResourceRecord -Force -Computername DNSServer-ZoneNam ...
Error: + ~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~
Error:     + CategoryInfo          : NotSpecified: (_acme-challenge.hoge2.frudens.app:root/Microsoft/...rResourceRecord) [Rem
Error:    ove-DnsServerResourceRecord], CimException
Error:     + FullyQualifiedErrorId : WIN32 1722,Remove-DnsServerResourceRecord

 [EROR] Error authorizing [Manual] [1 binding - hoge2.frudens.app]
 [EROR] AcmeWebException: Unexpected error
 +Response from server:
        + Code: BadRequest
        + Content: {
  &quot;type&quot;: &quot;urn:acme:error:badNonce&quot;,
  &quot;detail&quot;: &quot;JWS has invalid anti-replay nonce Y50_OdnTDpPBS4zJ10kh7_iojVNWr_hScGKEUl2w2rI&quot;,
  &quot;status&quot;: 400
}
 [EROR] Create certificate failed

 N: Create new certificate
 M: Create new certificate with advanced options
 L: List scheduled renewals
 R: Renew scheduled
 S: Renew specific
 A: Renew *all*
 V: Revoke certificate
 C: Cancel scheduled renewal
 X: Cancel *all* scheduled renewals
 Q: Quit

</code></pre>

<h3 id="そもそも">そもそも</h3>

<p>(上の内容のDNSserverは置き換えてください。)</p>

<p>Cloud DNSやRoute53であれば、API使えば設定できるけど、なんの認証もなく、DNSにTXTレコードを作成したり、削除することはできるわけないよね。</p>

<p>この作業って、TXTレコードに設定する文字列を取得するための作業だと思っていたけど、指定しているスクリプトを改めて見てみると、TXTレコードを作成したり、削除するような内容なんですよね。</p>

<p>そりゃ、できるわけないよね…</p>

<h2 id="go製のacmeクライアントを使えば良いのではないか">Go製のACMEクライアントを使えば良いのではないか？</h2>

<p>ということで、<a href="https://letsencrypt.org/docs/client-options/" target="_blank">ACME clients</a>を見てみる。</p>

<p>このためにGoをインストールしたくないしな…</p>

<h2 id="そもそもwindowsじゃなくて良いのではないか">そもそもWindowsじゃなくて良いのではないか？</h2>

<p>ここまで来たけど、Windowsで作業するのが嫌になってきたので、macOSかLinuxでDNS認証しよう！と思い、今回のチャレンジは失敗しました。</p>

<h2 id="あとがき">あとがき</h2>

<p>Windows 10 であれえば、WSL(Windows Subsystem for Linux)でLinuxをインストールして、certbotを実行すれば良いんですけどね…</p>

<p>今回は、Windows Server ですので…</p>

<p>Windowsとか、PowerShellとか、本当に辛い…</p></div>

  <footer class="article-footer">

    <section class="footer">
      <div>
        <nav class="crumb">
          <ol>
            <li><a href="https://www.trhrkmk.com/"><i class="fa fa-home" aria-hidden="true"></i>TOP</a></li>
            
            <li itemscope="" itemtype="http://data-vocabulary.org/Breadcrumb"><a href="https://www.trhrkmk.com/posts/" itemprop="url"><span itemprop="title">POSTS</span></a></li>
            
            <li class="active">Windows ServerでLet&#39;s EncryptのDNS認証を試みて失敗した話</li>
          </ol>
        </nav>
      </div>
    </section>

    
    
    
    <section class="footer">
      <header>
        <a href="https://www.trhrkmk.com/categories/">CATEGORIES</a>
      </header>
      <div>
        <ul class="terms">
          
          <li><a href="https://www.trhrkmk.com/categories/lets-encrypt/">Let&#39;s Encrypt</a></li>
          
        </ul>
      </div>
    </section>
    
    
    
    <section class="footer">
      <header>
        <a href="https://www.trhrkmk.com/tags/">TAGS</a>
      </header>
      <div>
        <ul class="terms">
          
          <li><a href="https://www.trhrkmk.com/tags/windows-server/">Windows Server</a></li>
          
          <li><a href="https://www.trhrkmk.com/tags/lets-encrypt/">Let&#39;s Encrypt</a></li>
          
          <li><a href="https://www.trhrkmk.com/tags/ssl/">SSL</a></li>
          
          <li><a href="https://www.trhrkmk.com/tags/dns/">DNS</a></li>
          
          <li><a href="https://www.trhrkmk.com/tags/win-acme/">win-acme</a></li>
          
        </ul>
      </div>
    </section>
    
    
  </footer>

</article>


<div class="adj">
  <div class="mrow">
    
    <div class="mcol c6">
      <header>Previous Article</header>
      <article class="lism">
  <a href="https://www.trhrkmk.com/amp/posts/hugo-link-target-blank-markdown/">
    <div class="thumb thumb-211a68066326af57662195e4fd3c867c"></div>

    <div class="inner">
      <div class="title">Hugoのリンクを新規タブ(target=&#39;_blank&#39;)で開く設定のメモ</div>

      <ul class="facts sm">
        <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2018-09-15T18:40:06JST">2018-09-15</time></li>
        <li><i class="fa fa-bookmark" aria-hidden="true"></i>POSTS</li>
        
      </ul>

    </div>
  </a>
</article>

    </div>
    
    
    <div class="mcol c6">
      <header>Next Article</header>
      <article class="lism">
  <a href="https://www.trhrkmk.com/amp/posts/lightsail-bitnami-redmine-letsencrypt/">
    <div class="thumb thumb-48829181f822197d67aae0bd2e10a89d"></div>

    <div class="inner">
      <div class="title">LightsailのRedmine(Bitnami)でLet&#39;s Encryptを手動更新するときのメモ</div>

      <ul class="facts sm">
        <li><i class="fa fa-calendar" aria-hidden="true"></i><time datetime="2018-09-30T16:06:11JST">2018-09-30</time></li>
        <li><i class="fa fa-bookmark" aria-hidden="true"></i>POSTS</li>
        
      </ul>

    </div>
  </a>
</article>

    </div>
    
  </div>
</div>


      </div>
    </main>

    <footer class="l-footer">
      <div class="l-container">
        <p>&copy; <a href="https://twitter.com/trhrkmk">trhrkmk</a> 2019</p>
        <aside>
          <p>Powered by <a href="https://gohugo.io/">Hugo</a>.</p>
          <p><a href="https://github.com/dim0627/hugo_theme_robust">Robust</a> designed by <a href="http://yet.unresolved.xyz/">Daisuke Tsuji</a>.</p>
        </aside>
      </div>
    </footer>
    <amp-auto-ads type="adsense"
              data-ad-client="ca-pub-7253798718530910">
</amp-auto-ads>
  </body>
</html>

